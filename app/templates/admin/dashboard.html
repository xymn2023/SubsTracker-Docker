{% extends 'admin/layout.html' %}

{% block title %}订阅管理 - 数据统计{% endblock %}

{% block additional_css %}
.chart-container {
  position: relative;
  height: 300px;
  width: 100%;
}
{% endblock %}

{% block content %}
<div class="mb-6">
  <h1 class="text-2xl font-bold text-gray-800">数据统计</h1>
  <p class="text-gray-600 mt-1">查看您的订阅费用和到期情况</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
  <div class="card p-6 flex flex-col">
    <div class="text-gray-500 text-sm font-medium mb-1">订阅总数</div>
    <div class="text-3xl font-bold text-gray-800 mb-2">{{ stats.total_count }}</div>
    <div class="text-sm text-gray-500 mt-auto">其中{{ stats.active_count }}个活跃订阅</div>
  </div>
  
  <div class="card p-6 flex flex-col">
    <div class="text-gray-500 text-sm font-medium mb-1">月均支出</div>
    <div class="text-3xl font-bold text-indigo-600 mb-2">¥{{ stats.monthly_cost }}</div>
    <div class="text-sm text-gray-500 mt-auto">每月订阅费用总计</div>
  </div>
  
  <div class="card p-6 flex flex-col">
    <div class="text-gray-500 text-sm font-medium mb-1">年度支出</div>
    <div class="text-3xl font-bold text-indigo-600 mb-2">¥{{ stats.yearly_cost }}</div>
    <div class="text-sm text-gray-500 mt-auto">每年订阅费用总计</div>
  </div>
  
  <div class="card p-6 flex flex-col">
    <div class="text-gray-500 text-sm font-medium mb-1">即将到期</div>
    <div class="text-3xl font-bold {% if stats.expiring_soon_count > 0 %}text-amber-500{% else %}text-green-500{% endif %} mb-2">{{ stats.expiring_soon_count }}</div>
    <div class="text-sm text-gray-500 mt-auto">7天内到期的订阅</div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <!-- 按周期分类饼图 -->
  <div class="card p-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">费用分布 (按周期)</h2>
    <div class="chart-container">
      <canvas id="periodChart"></canvas>
    </div>
  </div>
  
  <!-- 按状态分类饼图 -->
  <div class="card p-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">订阅状态分布</h2>
    <div class="chart-container">
      <canvas id="statusChart"></canvas>
    </div>
  </div>
</div>

<!-- 费用支出趋势图 -->
<div class="card p-6 mb-8">
  <h2 class="text-lg font-semibold text-gray-800 mb-4">费用支出趋势</h2>
  <div class="chart-container" style="height: 350px;">
    <canvas id="trendChart"></canvas>
  </div>
</div>

<!-- 即将到期订阅列表 -->
<div class="card p-6">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-semibold text-gray-800">即将到期的订阅</h2>
    {% if stats.expiring_soon %}
    <div class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-xs font-medium">
      <i class="fas fa-clock mr-1"></i>提醒已启用
    </div>
    {% endif %}
  </div>
  
  {% if stats.expiring_soon %}
  <div class="table-container">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">到期日</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">剩余天数</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for sub in stats.expiring_soon %}
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="font-medium text-gray-900">{{ sub.name }}</div>
            {% if sub.description %}
            <div class="text-sm text-gray-500">{{ sub.description }}</div>
            {% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-gray-900">{{ sub.expiry_date }}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="{% if sub.days_left <= 3 %}text-red-500{% elif sub.days_left <= 7 %}text-amber-500{% else %}text-gray-900{% endif %} font-medium">
              {{ sub.days_left }} 天
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <a href="/admin" class="btn btn-warning btn-sm">
              <i class="fas fa-edit mr-1"></i>续费
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state fade-in">
    <div class="empty-state-icon text-green-400">
      <i class="fas fa-check-circle"></i>
    </div>
    <h3 class="empty-state-title">没有即将到期的订阅</h3>
    <p class="empty-state-description">所有订阅都在安全期内，无需担心近期续费。</p>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block script %}
// 图表的自定义颜色
const chartColors = {
  primary: [
    'rgba(79, 70, 229, 0.8)',  // 主色 - 靛蓝色
    'rgba(99, 102, 241, 0.8)',
    'rgba(129, 140, 248, 0.8)',
    'rgba(165, 180, 252, 0.8)',
    'rgba(199, 210, 254, 0.8)',
  ],
  status: {
    active: 'rgba(16, 185, 129, 0.8)',    // 绿色 - 活跃
    expiring: 'rgba(245, 158, 11, 0.8)',  // 琥珀色 - 即将到期
    expired: 'rgba(239, 68, 68, 0.8)',    // 红色 - 已过期
  },
  trend: {
    line: 'rgba(79, 70, 229, 0.8)',       // 线条颜色
    fill: 'rgba(79, 70, 229, 0.1)',       // 填充颜色
    point: 'rgba(79, 70, 229, 1)',        // 点颜色
  }
};

// 通用图表配置
Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
Chart.defaults.color = '#6b7280';
Chart.defaults.scale.grid.color = '#f3f4f6';

// 周期分布饼图
const periodData = {{ stats.period_data|tojson }};
const periodChart = new Chart(
  document.getElementById('periodChart'),
  {
    type: 'doughnut',
    data: {
      labels: periodData.map(item => item.label),
      datasets: [
        {
          data: periodData.map(item => item.value),
          backgroundColor: chartColors.primary,
          borderColor: '#ffffff',
          borderWidth: 2,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '60%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = Math.round((value / total) * 100);
              return `${label}: ¥${value} (${percentage}%)`;
            }
          }
        }
      }
    }
  }
);

// 状态分布饼图
const statusData = {{ stats.status_data|tojson }};
const statusChart = new Chart(
  document.getElementById('statusChart'),
  {
    type: 'doughnut',
    data: {
      labels: statusData.map(item => item.label),
      datasets: [
        {
          data: statusData.map(item => item.value),
          backgroundColor: [
            chartColors.status.active,
            chartColors.status.expiring,
            chartColors.status.expired
          ],
          borderColor: '#ffffff',
          borderWidth: 2,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '60%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            usePointStyle: true,
            pointStyle: 'circle'
          }
        }
      }
    }
  }
);

// 费用支出趋势图
const trendData = {{ stats.trend_data|tojson }};
const trendChart = new Chart(
  document.getElementById('trendChart'),
  {
    type: 'line',
    data: {
      labels: trendData.labels,
      datasets: [
        {
          label: '月度支出',
          data: trendData.values,
          borderColor: chartColors.trend.line,
          backgroundColor: chartColors.trend.fill,
          pointBackgroundColor: chartColors.trend.point,
          pointBorderColor: '#ffffff',
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: true,
          tension: 0.2,
          borderWidth: 3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '¥' + value;
            }
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `费用: ¥${context.raw}`;
            }
          }
        },
        legend: {
          display: false
        }
      }
    }
  }
);
{% endblock %} 